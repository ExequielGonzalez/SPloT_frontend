"use strict";(self["webpackChunksplot_frontend"]=self["webpackChunksplot_frontend"]||[]).push([[686],{9828:(e,t,a)=>{a.d(t,{Z$:()=>r,m_:()=>c,l8:()=>d,pO:()=>p,qE:()=>u,ZV:()=>m,xT:()=>h,s$:()=>f,_w:()=>g,kf:()=>y,IT:()=>w});const o="http://localhost:5000",s="http://localhost:3001";async function n(e,t="GET"){let a={},o=await fetch(e,{method:`${t}`});return 200===o.status&&(a=await o.json()),{status:o.status,data:a}}async function i(e,t="POST",a){let o=await fetch(e,{method:`${t}`,headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return 200===o.status&&(a=await o.json()),{status:o.status,data:a}}async function l(e,t){let a=await fetch(`${s}/api/mqtt/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return 200===a.status&&(t=await a.json()),{status:a.status,data:t}}async function r(){return await n(`${o}/api/v1/actives`)}async function c(){return await n(`${o}/api/v1/reports/countPlaces`)}async function d(e){const t=await n(`${o}/api/v1/vehicles/${e}`);if(200!==t.status)return t;const a=await n(`${o}/api/v1/entries/?vehicleId=${t.data.id}`);if(200!==a.status)return a;const s=await n(`${o}/api/v1/vehiclePhotos?entryId=${a.data[0].id}`);return 200!==s.status?s:await n(`${o}/api/v1/vehiclePhotos/photo/${s.data[0].id}`)}async function p(e){return await n(`${o}/api/v1/entries/${e}`,"DELETE")}async function u(e=1630805031,t=1631669031){return await n(`${o}/api/v1/reports/collected?since=${e}&until=${t}`)}async function m(e=1630805031,t=1631669031){return await n(`${o}/api/v1/reports/occupation?since=${e}&until=${t}`)}async function h(e=1630805031,t=1631669031){return await n(`${o}/api/v1/reports/paymentMethods?since=${e}&until=${t}`)}async function f(e,t){return await i(`${o}/api/v1/entries/${e}`,"PUT",t)}async function g(e){return await i(`${o}/api/v1/payments`,"POST",e)}async function y(e){return await n(`${o}/api/v1/trafficlights?id=${e}`)}async function w(e){return await l("traffic_light",{id:e,data:"1"})}},1686:(e,t,a)=>{a.r(t),a.d(t,{default:()=>ye});var o=a(3673);const s={class:"home-header q-pa-lg"};function n(e,t,a,n,i,l){const r=(0,o.up)("PlacesCounter"),c=(0,o.up)("SearchBar"),d=(0,o.up)("TablePlates"),p=(0,o.up)("NotificationOut"),u=(0,o.up)("q-page"),m=(0,o.up)("image-viewer"),h=(0,o.up)("PaymentDialog");return(0,o.wg)(),(0,o.iD)(o.HY,null,[(0,o.Wm)(u,{class:"q-pa-md"},{default:(0,o.w5)((()=>[(0,o._)("section",s,[(0,o.Wm)(r,{title:"Lugares generales",places:e.parkPlaces},null,8,["places"]),(0,o.Wm)(r,{title:"Lugares motos",places:e.motorbikePlaces},null,8,["places"])]),(0,o.Wm)(c,{onResult:e.filterPlates,onSearchError:e.showEmptyTable,plates:JSON.parse(JSON.stringify(this.activePlates)),ref:"searchBarRef"},null,8,["onResult","onSearchError","plates"]),(0,o.Wm)(d,{plates:0!==JSON.parse(JSON.stringify(this.filteredPlates)).length?JSON.parse(JSON.stringify(this.filteredPlates)):this.emptyTable?[]:JSON.parse(JSON.stringify(this.activePlates)),onViewPhoto:e.showPhoto,onAddManualEntry:e.addManualEntry,onDeleteUser:e.deleteEntry},null,8,["plates","onViewPhoto","onAddManualEntry","onDeleteUser"]),(0,o.Wm)(p,{onManagePayment:e.managePayment,ref:"notificationOutRef"},null,8,["onManagePayment"])])),_:1}),(0,o.Wm)(m,{ref:"imageViewerRef"},null,512),(0,o.Wm)(h,{ref:"paymentDialogRef",onPaymentRealized:e.paymentRealized},null,8,["onPaymentRealized"])],64)}a(246);var i=a(8825),l=a(2323);(0,o.dD)("data-v-42756826");const r={class:"q-pa-md"},c={class:"table__top"},d=(0,o._)("h6",null,"Patentes activas",-1),p={key:0},u={key:1},m=(0,o._)("strong",null,"Borrar",-1);function h(e,t,a,s,n,i){const h=(0,o.up)("q-btn"),f=(0,o.up)("q-td"),g=(0,o.up)("q-tooltip"),y=(0,o.up)("q-table");return(0,o.wg)(),(0,o.iD)("div",r,[(0,o.Wm)(y,{dense:e.$q.screen.lt.md,title:"Plates",columns:e.columns,rows:e.plates,"row-key":"entryId","rows-per-page-options":[15]},{top:(0,o.w5)((()=>[(0,o._)("div",c,[d,(0,o.Wm)(h,{color:"primary",label:"Añadir ingreso",onClick:e.addEntry},null,8,["onClick"])])])),"body-cell":(0,o.w5)((e=>[(0,o.Wm)(f,{props:e,class:"table__items"},{default:(0,o.w5)((()=>[(0,o._)("span",null,(0,l.zw)(e.value),1)])),_:2},1032,["props"])])),"body-cell-actions":(0,o.w5)((t=>[(0,o.Wm)(f,{key:"actions",props:t},{default:(0,o.w5)((()=>[(0,o.Wm)(h,{flat:"",onClick:a=>e.showPhoto(t.row),icon:"visibility",color:t.row.hasPhoto?"primary":"grey"},{default:(0,o.w5)((()=>[(0,o.Wm)(g,{"content-style":"font-size: 14px","transition-show":"scale","transition-hide":"scale",anchor:"top middle",self:"bottom middle",offset:[10,10]},{default:(0,o.w5)((()=>[t.row.hasPhoto?((0,o.wg)(),(0,o.iD)("strong",p,"Ver más")):(0,o.kq)("",!0),t.row.hasPhoto?(0,o.kq)("",!0):((0,o.wg)(),(0,o.iD)("strong",u,"No disponible"))])),_:2},1024)])),_:2},1032,["onClick","color"]),(0,o.Wm)(h,{flat:"",onClick:a=>e.deleteRecord(t.row.entryId),icon:"delete",color:"negative"},{default:(0,o.w5)((()=>[(0,o.Wm)(g,{"content-style":"font-size: 14px","transition-show":"scale","transition-hide":"scale",anchor:"top middle",self:"bottom middle",offset:[10,10]},{default:(0,o.w5)((()=>[m])),_:1})])),_:2},1032,["onClick"])])),_:2},1032,["props"])])),_:1},8,["dense","columns","rows"])])}(0,o.Cn)();a(7280),a(5363);const f=(0,o.aZ)({props:{plates:Array},data(){return{columns:[{name:"type",label:"Tipo",field:e=>e.type,format:e=>"car"===e?"Auto":"van"===e?"Camioneta":"Moto",sortable:!0,align:"left"},{name:"plateNumber",label:"Patente",field:e=>e.plateNumber,format:e=>`${e.replace("_","")}`,sortable:!0,align:"left"},{name:"entryTime",label:"Horario de ingreso",field:e=>e.entryTime,format:e=>new Date(e).toLocaleString(),sortable:!0,align:"left"},{name:"cost",label:"Monto actual",field:e=>e.cost,format:e=>`$${e}`,sortable:!0,align:"left"},{name:"actions",field:"actions",label:"Acciones",align:"center"}]}},methods:{showPhoto(e){e.hasPhoto&&this.$emit("view-photo",e.plateNumber)},async deleteRecord(e){this.$emit("delete-user",e)},addEntry(){this.$emit("add-manual-entry")}}});var g=a(6429),y=a(2025),w=a(8240),v=a(3884),b=a(8870),_=a(7518),P=a.n(_);f.render=h,f.__scopeId="data-v-42756826";const $=f;P()(f,"components",{QTable:g.Z,QSpace:y.Z,QBtn:w.Z,QTd:v.Z,QTooltip:b.Z});const C={class:"row q-mb-md justify-center"},N={class:"q-pt-md col-xs-12 col-sm-12 col-md-10 q-px-sm"};function T(e,t,a,s,n,i){const l=(0,o.up)("q-icon"),r=(0,o.up)("q-input");return(0,o.wg)(),(0,o.iD)("div",C,[(0,o._)("div",N,[(0,o.Wm)(r,{label:"Buscar por patente",outlined:"",dense:"",modelValue:e.searchText,"onUpdate:modelValue":[t[0]||(t[0]=t=>e.searchText=t),e.onSearchTextChange]},{append:(0,o.w5)((()=>[(0,o.Wm)(l,{name:"search"})])),_:1},8,["modelValue","onUpdate:modelValue"])])])}const S=(0,o.aZ)({props:{plates:Array},data(){return{platesFiltered:[],searchText:""}},methods:{onSearchTextChange(){this.searchText&&""!==this.searchText?this.platesFiltered=this.plates.filter((e=>e.plateNumber.toString().toLowerCase().includes(this.searchText.toLowerCase())||e.type.toString().toLowerCase().includes(this.searchText.toLowerCase()))):this.platesFiltered=this.plates,this.$emit("result",JSON.parse(JSON.stringify(this.platesFiltered))),0===this.platesFiltered.length&&this.$emit("search-error",JSON.parse(JSON.stringify(this.platesFiltered)))},cleanSearchBar(){this.searchText=""}}});var k=a(4842),D=a(4554);S.render=T;const q=S;P()(S,"components",{QInput:k.Z,QIcon:D.Z}),(0,o.dD)("data-v-63a3faa7");const O={class:"counter"},V={class:"counter__title"},Z={class:"counter__container-free"},W=(0,o._)("p",null,"LIBRES",-1),E={class:"counter__container-busy"},R=(0,o._)("p",null,"OCUPADOS",-1);function x(e,t,a,s,n,i){return(0,o.wg)(),(0,o.iD)("div",O,[(0,o._)("p",V,(0,l.zw)(e.title),1),(0,o._)("div",Z,[W,(0,o._)("p",null,(0,l.zw)(null===e.places.free?0:e.places.free),1)]),(0,o._)("div",E,[R,(0,o._)("p",null,(0,l.zw)(null===e.places.busy?0:e.places.busy),1)])])}(0,o.Cn)();const I=(0,o.aZ)({props:{title:String,places:{busy:Number,free:Number}}});I.render=x,I.__scopeId="data-v-63a3faa7";const M=I;(0,o.dD)("data-v-ed2b6158");const Q={ref:"imageComponent",id:"theImg"};function J(e,t,a,s,n,i){const l=(0,o.up)("q-card"),r=(0,o.up)("q-dialog");return(0,o.wg)(),(0,o.j4)(r,{modelValue:s.card,"onUpdate:modelValue":t[0]||(t[0]=e=>s.card=e)},{default:(0,o.w5)((()=>[(0,o.Wm)(l,{class:"imageViewer"},{default:(0,o.w5)((()=>[(0,o._)("img",Q,null,512)])),_:1})])),_:1},8,["modelValue"])}(0,o.Cn)();var U=a(1959);const j={setup(){const e=(0,U.iH)(!1),t=(0,U.iH)(null);return(0,o.bv)((()=>{})),{card:e,imageComponent:t}},data(){return{imageData:String}},methods:{showModal(e){this.card=!0,this.showPhoto(e)},hideModal(){this.card=!1},showPhoto(e){setTimeout((()=>{console.log(e),this.$refs.imageComponent.src=`data:image/png;base64,${this.toBase64(e.photo.data)}`}),1)},toBase64(e){return btoa(e.reduce(((e,t)=>e+String.fromCharCode(t)),""))}}};var z=a(6778),B=a(151);j.render=J,j.__scopeId="data-v-ed2b6158";const A=j;function H(e,t,a,s,n,i){return(0,o.wg)(),(0,o.iD)("div")}P()(j,"components",{QDialog:z.Z,QCard:B.Z});const L=(0,o.aZ)({name:"NotificationOut",setup(){const e=(0,i.Z)();return{showNotif(t){e.notify({message:"Un vehículo esta listo para retirarse.",color:"primary",timeout:0,icon:"info",group:!1,position:"bottom-right",actions:[{label:"Cobrar",color:"yellow",handler:()=>{this.$emit("manage-payment",t)}}]})}}},props:{},methods:{}});L.render=H;const F=L;(0,o.dD)("data-v-4f2e57d3");const G={class:"payment__image",ref:"imageComponent",id:"theImg",src:"http://www.albiladdailyeng.com/wp-content/uploads/2018/07/880x495_cmsv2_7624e743-e9f7-508f-b4f3-b3e86c31ca30-3226692.jpg"},Y={style:{color:"black","padding-left":"10px"}},K={key:1,class:"payment__data-text"};function X(e,t,a,s,n,i){const r=(0,o.up)("q-input"),c=(0,o.up)("q-select"),d=(0,o.up)("q-btn"),p=(0,o.up)("q-card-actions"),u=(0,o.up)("q-card-section"),m=(0,o.up)("q-separator"),h=(0,o.up)("q-card"),f=(0,o.up)("q-dialog");return(0,o.wg)(),(0,o.j4)(f,{persistent:"",modelValue:e.dialog,"onUpdate:modelValue":t[5]||(t[5]=t=>e.dialog=t),style:{width:"75vw"}},{default:(0,o.w5)((()=>[(0,o.Wm)(h,{class:"payment"},{default:(0,o.w5)((()=>[(0,o.Wm)(u,{horizontal:""},{default:(0,o.w5)((()=>[(0,o._)("img",G,null,512),(0,o.Wm)(u,{class:"payment__data"},{default:(0,o.w5)((()=>[(0,o.Wm)(r,{ref:"plateNumberRef",modelValue:e.plateNumber,"onUpdate:modelValue":t[0]||(t[0]=t=>e.plateNumber=t),label:"Número de patente",maxlength:"7",counter:"","reactive-rules":"",rules:[e=>e.length>=6||"Mínimo 6 caracteres"]},null,8,["modelValue","rules"]),(0,o.Wm)(c,{modelValue:e.vehicle,"onUpdate:modelValue":t[1]||(t[1]=t=>e.vehicle=t),options:e.vehicleOptions,label:"Tipo de vehículo","stack-label":""},null,8,["modelValue","options"]),(0,o.Wm)(c,{modelValue:e.payment,"onUpdate:modelValue":t[2]||(t[2]=t=>e.payment=t),options:e.paymentOptions,label:"Tipo de pago","stack-label":""},null,8,["modelValue","options"]),(0,o.Wm)(r,{color:"black","bg-color":"deep-purple-2",modelValue:e.cost,"onUpdate:modelValue":t[3]||(t[3]=t=>e.cost=t),outlined:"",prefix:"$",label:"Monto a cobrar",placeholder:"","input-style":{"font-size":"1.2rem"},rules:[e=>e>=0||"El valor no puede ser negativo"],"reactive-rules":"",type:"number",style:{"padding-top":"10px"}},{label:(0,o.w5)((()=>[(0,o._)("span",Y,"Monto a cobrar ($"+(0,l.zw)(e.initialCost)+")",1)])),_:1},8,["modelValue","input-style","rules"]),"Efectivo"===e.payment?((0,o.wg)(),(0,o.j4)(r,{key:0,modelValue:e.moneyReceived,"onUpdate:modelValue":t[4]||(t[4]=t=>e.moneyReceived=t),label:"Paga con:",prefix:"$"},null,8,["modelValue"])):(0,o.kq)("",!0),"Efectivo"===e.payment&&""!==e.moneyReceived?((0,o.wg)(),(0,o.iD)("h6",K,"Vuelto: $"+(0,l.zw)(parseFloat(e.moneyReceived)-parseFloat(e.cost)),1)):(0,o.kq)("",!0),(0,o.Wm)(p,{align:"right"},{default:(0,o.w5)((()=>[(0,o.Wm)(d,{flat:"",color:"primary",label:"Cobrar",onClick:e.makePayment},null,8,["onClick"])])),_:1})])),_:1})])),_:1}),(0,o.Wm)(m)])),_:1})])),_:1},8,["modelValue"])}(0,o.Cn)();var ee=a(515),te=a.n(ee);const ae=(0,o.aZ)({name:"PaymentDialog",setup(){(0,i.Z)();return{dialog:(0,U.iH)(!1),plateNumber:(0,U.iH)(""),initialCost:(0,U.iH)("0"),moneyReceived:(0,U.iH)(""),vehicle:(0,U.iH)("Motocicleta"),payment:(0,U.iH)("Efectivo"),cost:(0,U.iH)("0"),vehicleOptions:["Auto","Camioneta","Motocicleta"],paymentOptions:["Efectivo","Tarjeta de credito","Tajeta de debito"]}},data(){return{imageData:String,vehicleData:{}}},props:{},methods:{makePayment(){if(this.checkConditions()){console.log("realizando pago");const e=te()(te()({},this.vehicleData),{},{cost:this.cost,computePayment:!1,exitTime:(new Date).getTime(),method:"Efectivo"===this.payment?"Cash":"Tarjeta de credito"===this.payment?"Credit Card":"Debit Card"});console.log(this.vehicleData),Object.keys(this.vehicleData).length>0&&this.vehicleData.plateNumber.toUpperCase()!==this.plateNumber.toUpperCase()&&(e.plateNumber=this.plateNumber.toUpperCase()),Object.keys(this.vehicleData).length>0&&6===e.plateNumber.length&&(e.plateNumber+="_"),console.log(e),this.$emit("payment-realized",e),this.hideDialog()}else this.$refs.plateNumberRef.validate()},showDialog(e,t){this.dialog=!0,void 0!==t&&""!==t&&(console.log("en el dialog: ",t),this.vehicleData=t,this.cost=t.cost,this.initialCost=t.cost,"car"===t.type?this.vehicle="Auto":"van"===t.type?this.vehicle="Camioneta":this.vehicle="Motocicleta",this.plateNumber=t.plateNumber),void 0!==e&&""!==e&&this.showPhoto(e)},hideDialog(){this.plateNumber="",this.moneyReceived="",this.vehicle="Motocicleta",this.payment="Efectivo",this.dialog=!1},showPhoto(e){setTimeout((()=>{console.log(e),this.$refs.imageComponent.src=`data:image/png;base64,${this.toBase64(e.photo.data)}`}),1)},toBase64(e){return btoa(e.reduce(((e,t)=>e+String.fromCharCode(t)),""))},checkConditions(){return this.plateNumber.length>=6&&this.plateNumber.length<=7}}});var oe=a(5589),se=a(8516),ne=a(9367),ie=a(5869);ae.render=X,ae.__scopeId="data-v-4f2e57d3";const le=ae;P()(ae,"components",{QDialog:z.Z,QCard:B.Z,QCardSection:oe.Z,QInput:k.Z,QSelect:se.Z,QCardActions:ne.Z,QBtn:w.Z,QSeparator:ie.Z});var re=a(5615);function ce(e){return(0,re.ZP)(`http://localhost:${e}`)}function de(e,t){e.on("active_plates_update",(()=>{t()}))}function pe(e,t){e.on("new_alert",(e=>{t(e)}))}function ue(e,t){e.on("register_payment",(e=>{console.log(e),t(e)}))}var me=a(9828);const he=(0,o.aZ)({name:"Home",components:{TablePlates:$,SearchBar:q,PlacesCounter:M,ImageViewer:A,NotificationOut:F,PaymentDialog:le},setup(){(0,i.Z)()},data(){return{wsNotification:!1,parkPlaces:{total:0,free:0,busy:0},motorbikePlaces:{total:0,free:0,busy:0},plates:{},activePlates:[],filteredPlates:[],emptyTable:!1}},mounted(){const e=ce(5e3);de(e,this.newMessage),pe(e,this.handleAlarms),ue(e,this.handlePaymentRequest),this.filteredPlates=Object.values(this.plates),this.newMessage()},methods:{async newMessage(){let e,t={},a={};e=await(0,me.Z$)(),200===e.status&&(t=e.data),this.activePlates=t,e=await(0,me.m_)(),200===e.status&&(a=e.data),this.parkPlaces=a.carsAndVans,this.motorbikePlaces=a.motorbikes},newEntry(){console.log("nuevo ingreso")},handleAlarms(e){const t={Info:"info",Warning:"warning",Error:"negative"};e=JSON.parse(e),console.log("new Alarm: ",e),this.$q.notify({message:e.title,caption:e.description,color:t[e.type]})},filterPlates(e){this.emptyTable=!1,this.filteredPlates=JSON.parse(JSON.stringify(e))},showEmptyTable(){this.emptyTable=!0},async showPhoto(e){console.log(e);let t="",a=await(0,me.l8)(e);200===a.status&&(t=a.data),this.$refs.imageViewerRef.showModal(t)},async deleteEntry(e){this.$q.dialog({title:"Eliminar ingreso",message:"¿Esta seguro que desea eliminar este ingreso?",ok:{color:"negative",label:"eliminar"},cancel:{color:"accent"}}).onOk((async()=>{console.log("eliminando la entry: ",e);const t=await(0,me.pO)(e);200===t.status?(this.$refs.searchBarRef.cleanSearchBar(),await this.newMessage(),this.filteredPlates=[],this.$q.notify({progress:!0,message:"Se eliminó el ingreso correctamente",color:"accent"})):this.$q.notify({progress:!0,message:"No se ha podido eliminar el ingreso seleccionado",color:"negative"})}))},async handlePaymentRequest(e){e=JSON.parse(e),console.log("This is a new payment request: ",e);const t=this.activePlates.filter((t=>t.entryId==e.entryId));this.$refs.notificationOutRef.showNotif(t)},async managePayment(e){e=e[0],console.log("ahora si va el popup",e);let t="";if(e.hasPhoto){console.log("tiene foto");let a=await(0,me.l8)(e.plateNumber);200===a.status&&(t=a.data)}this.$refs.paymentDialogRef.showDialog(t,e)},async paymentRealized(e){console.log("time to save the payment: ",e);let t=await(0,me.s$)(e.entryId,{exitTime:e.exitTime,computePayment:!1});if(200===t.status){console.log("entry edited succesfully: ",t);let a=await(0,me._w)({amount:e.cost,method:e.method,entryId:e.entryId});console.log("payment created succesfully: ",a);const o=await(0,me.kf)(t.data.exitPassagewayId);(0,me.IT)(o.data[0].id)}},async addManualEntry(){(0,me.IT)("1")}}});var fe=a(4379),ge=a(4899);he.render=n;const ye=he;P()(he,"components",{QPage:fe.Z,QBtn:w.Z,QLayout:ge.Z})}}]);